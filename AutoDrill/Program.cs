using Sandbox.ModAPI.Ingame;
using SpaceEngineers.Game.ModAPI.Ingame;
using System;
using System.Collections.Generic;
using System.Linq;
using VRage.Game.GUI.TextPanel;
using VRage.Game.ModAPI.Ingame.Utilities;
using VRageMath;

namespace IngameScript
{
    partial class Program : MyGridProgram
    {
        public class AutoDrill
        {
            public List<IMyTerminalBlock> DrillHead { get; internal set; }
            public List<Piston> CenterPistons { get; internal set; }
            public AutoDrillArm UpperArm { get; internal set; }
            public AutoDrillArm LowerArm { get; internal set; }
            public List<IMyTextSurface> InfoDisplays { get; internal set; }
            public List<IMyTextSurface> LogoDisplays { get; internal set; }
        }

        public class Piston
        {
            public IMyPistonBase PistonBase { get; private set; }
            public float BaseLength { get; private set; }
            public float CurrentLength { get { return BaseLength + PistonBase.CurrentPosition - PistonBase.MinLimit; } }
            public float MaxLength { get { return BaseLength + PistonBase.MaxLimit - PistonBase.MinLimit; } }
            public float CurrentExtension { get { return PistonBase.CurrentPosition - PistonBase.MinLimit; } }
            public float MaxExtension { get { return PistonBase.MaxLimit - PistonBase.MinLimit; } }

            public Piston(IMyPistonBase pistonBase)
            {
                this.PistonBase = pistonBase;
                this.BaseLength = pistonBase.HighestPosition / 2;
            }
        }

        public class AutoDrillArm
        {
            public List<IMyPistonBase> Pistons { get; internal set; }
            public List<IMyShipMergeBlock> MergeBlocks { get; internal set; }
            public List<IMyShipConnector> Connectors { get; internal set; }

            /*public AutoDrillArmPistonStatus GetPistonStatus()
            {
                List<PistonStatus> pistonStatusList = Pistons.Select(p => p.Status).ToList();
                if (pistonStatusList.Exists(ps => ps.Equals(PistonStatus.Extending)))
                {
                    return AutoDrillArmPistonStatus.Extending;
                }
                if (pistonStatusList.Exists(ps => ps.Equals(PistonStatus.Retracting)))
                {
                    return AutoDrillArmPistonStatus.Retracting;
                }
                if (pistonStatusList.All(ps => ps.Equals(PistonStatus.Extended)))
                {
                    return AutoDrillArmPistonStatus.Extended;
                }
                if (pistonStatusList.All(ps => ps.Equals(PistonStatus.Retracted)))
                {
                    return AutoDrillArmPistonStatus.Retracted;
                }
                return AutoDrillArmPistonStatus.Unknown;
            }

            public bool AreAllJointsConnected()
            {
                return GetJointsConnectionStatus().All(jcs => jcs);
            }

            public bool AreAllJointsUnconnected()
            {
                return GetJointsConnectionStatus().All(jcs => !jcs);
            }

            public bool AreAllJointsConnectable()
            {
                return MergeBlocks.Select(j => j.CheckConnectionAllowed).All(ca => ca);
            }

            private List<bool> GetJointsConnectionStatus()
            {
                return MergeBlocks.Select(j => j.IsConnected).ToList();
            }

            public bool AreAllConnectorsConnectable()
            {
                return AreAllConnectorsInStatus(MyShipConnectorStatus.Connectable);
            }

            public bool AreAllConnectorsConnected()
            {
                return AreAllConnectorsInStatus(MyShipConnectorStatus.Connected);
            }

            public bool AreAllConnectorsUnconnected()
            {
                return AreAllConnectorsInStatus(MyShipConnectorStatus.Unconnected);
            }

            private bool AreAllConnectorsInStatus(MyShipConnectorStatus status)
            {
                return GetConnectorsStatus().All(cs => cs.Equals(status));
            }

            private List<MyShipConnectorStatus> GetConnectorsStatus()
            {
                return Connectors.Select(cs => cs.Status).ToList();
            }*/
        }

        /*public enum AutoDrillArmPistonStatus
        {
            Retracted,
            Retracting,
            Extended,
            Extending,
            Unknown
        }*/

        private static readonly string autoDrillKey = "AutoDrill";
        private static readonly string drillHeadGroupKey = "DrillHeadGroup";
        private static readonly string centerPistonGroupKey = "CenterPistonGroup";
        private static readonly string upperArmGroupKey = "UpperArmGroup";
        private static readonly string lowerArmGroupKey = "LowerArmGroup";
        private static readonly string displayGroupKey = "DisplayGroup";

        private static readonly string infoDisplayTag = "[I]";
        private static readonly string logoDisplayTag = "[L]";

        readonly MyIni _ini;
        readonly AutoDrill _autoDrill;

        public Program()
        {
            Runtime.UpdateFrequency = UpdateFrequency.Update100;
            _ini = new MyIni();

            try
            {
                _autoDrill = InitAutoDrill();
                ConfigureDisplays();

                _autoDrill.LogoDisplays.ForEach(ld =>
                {
                    ld.WriteText("", false);
                    ld.WriteText(logo, false);
                });
            }
            catch (Exception e)
            {
                Echo(e.Message);
                throw new Exception();
            }
        }

        private AutoDrill InitAutoDrill()
        {
            var customData = Me.CustomData;
            MyIniParseResult result;
            if (!_ini.TryParse(Me.CustomData, out result))
            {
                throw new Exception(result.ToString());
            }

            var drillHeadGroup = GetGroupByConfigKey(drillHeadGroupKey);
            var centerPistonGroup = GetGroupByConfigKey(centerPistonGroupKey);
            var upperArmGroup = GetGroupByConfigKey(upperArmGroupKey);
            var lowerArmGroup = GetGroupByConfigKey(lowerArmGroupKey);
            var displayGroup = GetGroupByConfigKey(displayGroupKey);

            var drillHead = new List<IMyTerminalBlock>();
            drillHeadGroup.GetBlocks(drillHead);

            var centerPistonBases = new List<IMyPistonBase>();
            centerPistonGroup.GetBlocksOfType(centerPistonBases);
            var centerPistons = InitPistons(centerPistonBases);

            var upperArm = InitAutoDrillArm(upperArmGroup);
            var lowerArm = InitAutoDrillArm(lowerArmGroup);

            var displays = new List<IMyTextSurface>();
            displayGroup.GetBlocksOfType(displays);
            var infoDisplays = FilterTextSurfacesByTag(displays, infoDisplayTag);
            var logoDisplays = FilterTextSurfacesByTag(displays, logoDisplayTag);

            return new AutoDrill { DrillHead = drillHead, CenterPistons = centerPistons, UpperArm = upperArm, LowerArm = lowerArm, InfoDisplays = infoDisplays, LogoDisplays = logoDisplays };
        }

        private IMyBlockGroup GetGroupByConfigKey(string key)
        {
            var groupName = GetValueFromCustomDataByKey(key);
            var group = GridTerminalSystem.GetBlockGroupWithName(groupName);
            if (group == null)
            {
                throw new Exception($"No group named '{key}' found.");
            }
            return group;
        }

        private string GetValueFromCustomDataByKey(string key)
        {
            return _ini.Get(autoDrillKey, key).ToString();
        }

        private List<Piston> InitPistons(List<IMyPistonBase> pistonBases)
        {
            var pistons = new List<Piston>(pistonBases.Count);
            for (int i = 0; i < pistonBases.Count; i++)
            {
                var pistonBase = pistonBases[i];
                pistons.Add(new Piston(pistonBase));
            }
            return pistons;
        }

        private AutoDrillArm InitAutoDrillArm(IMyBlockGroup autoDrillArmGroup)
        {
            var pistons = new List<IMyPistonBase>();
            var mergeBlocks = new List<IMyShipMergeBlock>();
            var connectors = new List<IMyShipConnector>();

            autoDrillArmGroup.GetBlocksOfType(pistons);
            autoDrillArmGroup.GetBlocksOfType(mergeBlocks);
            autoDrillArmGroup.GetBlocksOfType(connectors);

            if (!pistons.Any())
            {
                throw new Exception($"No pistons for group {autoDrillArmGroup.Name} configured.");
            }
            if (!mergeBlocks.Any())
            {
                throw new Exception($"No merge blocks for group {autoDrillArmGroup.Name} configured.");
            }
            if (!connectors.Any())
            {
                throw new Exception($"No connectors for group {autoDrillArmGroup.Name} configured.");
            }

            return new AutoDrillArm { Pistons = pistons, MergeBlocks = mergeBlocks, Connectors = connectors };
        }

        private List<IMyTextSurface> FilterTextSurfacesByTag(List<IMyTextSurface> textSurfaces, string tag)
        {
            return textSurfaces.FindAll(ts => (ts as IMyTerminalBlock).CustomName.Contains(tag));
        }

        private void ConfigureDisplays()
        {
            ConfigureTextSurfaces(_autoDrill.InfoDisplays);
            ConfigureLogoSurfaces(_autoDrill.LogoDisplays);
        }

        private void ConfigureTextSurfaces(List<IMyTextSurface> textSurfaces)
        {
            foreach (var textSurface in textSurfaces)
            {
                textSurface.ContentType = ContentType.TEXT_AND_IMAGE;
                textSurface.BackgroundColor = Color.Black;
                textSurface.Font = "Monospace";
                textSurface.FontSize = 0.75f;
                textSurface.Alignment = TextAlignment.LEFT;
                textSurface.WriteText("", false);
            }
        }

        private void ConfigureLogoSurfaces(List<IMyTextSurface> textSurfaces)
        {
            foreach (var textSurface in textSurfaces)
            {
                textSurface.ContentType = ContentType.TEXT_AND_IMAGE;
                textSurface.BackgroundColor = Color.Black;
                textSurface.Font = "Monospace";
                textSurface.FontSize = 0.1f;
                textSurface.Alignment = TextAlignment.LEFT;
                textSurface.TextPadding = 0;
                textSurface.WriteText("", false);
            }
        }

        public void Main(string argument, UpdateType updateSource)
        {
            _autoDrill.InfoDisplays.ForEach(id =>
            {
                id.WriteText("", false);
                PrintCenterPistonStatus(id, _autoDrill.CenterPistons);
                PrintAutoDrillArmStatus(id, _autoDrill.UpperArm, "Upper Arm");
                PrintAutoDrillArmStatus(id, _autoDrill.LowerArm, "Lower Arm");
            });
        }

        private void PrintCenterPistonStatus(IMyTextSurface textSurface, List<Piston> pistons)
        {
            var totalVelocity = pistons.Sum(p => p.PistonBase.Velocity);
            var totalExtension = pistons.Sum(p => p.CurrentExtension);
            var maxExtension = pistons.Sum(p => p.MaxExtension);
            var totalLength = pistons.Sum(p => p.CurrentLength);
            var maxLength = pistons.Sum(p => p.MaxLength);

            textSurface.WriteText("═ Central Piston ═\n", true);
            textSurface.WriteText($"Total velocity:  {totalVelocity,5:F3}m/s\n", true);
            textSurface.WriteText($"Total Extension: {totalExtension,5:F3}m / {maxExtension,5:F3}m\n", true);
            textSurface.WriteText($"Total Length:    {totalLength,5:F3}m / {maxLength,5:F3}m\n", true);
        }

        private void PrintAutoDrillArmStatus(IMyTextSurface textSurface, AutoDrillArm autoDrillArm, string label)
        {
            textSurface.WriteText($"═ {label} ═\n", true);

            for (int i = 0; i < autoDrillArm.MergeBlocks.Count; i++)
            {
                var mergeBlock = autoDrillArm.MergeBlocks[i];

                if (mergeBlock.IsConnected)
                {
                    textSurface.WriteText($"Merge Block {i + 1}: ╠╣\n", true);
                }
                else
                {
                    if (mergeBlock.CheckConnectionAllowed)
                    {
                        textSurface.WriteText($"Merge Block {i + 1}: ╠ ╣\n", true);
                    }
                    else
                    {
                        textSurface.WriteText($"Merge Block {i + 1}: ╠XX╣\n", true);
                    }
                }
            }
            for (int i = 0; i < autoDrillArm.Connectors.Count; i++)
            {
                var connector = autoDrillArm.Connectors[i];

                switch (connector.Status)
                {
                    case MyShipConnectorStatus.Connected:
                        textSurface.WriteText($"Connector   {i + 1}: ╠╣\n", true);
                        break;
                    case MyShipConnectorStatus.Connectable:
                        textSurface.WriteText($"Connector   {i + 1}: ╠ ╣\n", true);
                        break;
                    case MyShipConnectorStatus.Unconnected:
                        textSurface.WriteText($"Connector   {i + 1}: ╠│╣\n", true);
                        break;
                }
            }
            for (int i = 0; i < autoDrillArm.Pistons.Count; i++)
            {
                var piston = autoDrillArm.Pistons[i];

                switch (piston.Status)
                {
                    case PistonStatus.Stopped:
                        textSurface.WriteText($"Piston      {i + 1}: ███\n", true);
                        break;
                    case PistonStatus.Extending:
                        //textSurface.WriteText($"Piston      {i + 1}: ►►►\n", true);
                        textSurface.WriteText($"Piston      {i + 1}: ╠►╣\n", true);
                        break;
                    case PistonStatus.Extended:
                        //textSurface.WriteText($"Piston      {i + 1}: ►►█\n", true);
                        textSurface.WriteText($"Piston      {i + 1}: ╠═╣\n", true);
                        break;
                    case PistonStatus.Retracting:
                        //textSurface.WriteText($"Piston      {i + 1}: ◄◄◄\n", true);
                        textSurface.WriteText($"Piston      {i + 1}: ╠◄╣\n", true);
                        break;
                    case PistonStatus.Retracted:
                        //textSurface.WriteText($"Piston      {i + 1}: █◄◄\n", true);
                        textSurface.WriteText($"Piston      {i + 1}: ╠╣\n", true);
                        break;
                }
            }
        }

        private static readonly string logo = @"

















































































































































































WIC v1.2.3.3 - Dither mode: (None) - 178x178 px";
    }
}
